---
import SectionHeader from './shared/SectionHeader.astro';
import FormInput from './shared/FormInput.astro';

const serviceOptions = [
    { value: 'landing', label: 'Landing Page' },
    { value: 'web', label: 'Firemný web' },
    { value: 'eshop', label: 'E-shop' },
    { value: 'custom', label: 'Iné' }
];
---

<section id="contact" class="py-24" aria-label="Kontaktný formulár">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 md:p-12 reveal">
            <SectionHeader
                    title="Začnime spoluprácu"
                    description="Napíšte nám a my sa vám ozveme do 24 hodín"
            />

            <form id="contact-form" class="grid md:grid-cols-2 gap-6">
                <div class="md:col-span-1">
                    <FormInput label="Meno a priezvisko" name="name" required={true} />
                </div>
                <div class="md:col-span-1">
                    <FormInput label="Email" type="email" name="email" required={true} />
                </div>
                <div class="md:col-span-1">
                    <FormInput label="Telefón" type="tel" name="phone" />
                </div>
                <div class="md:col-span-1">
                    <FormInput
                            label="Typ služby"
                            type="select"
                            name="service"
                            required={true}
                            options={serviceOptions}
                    />
                </div>
                <div class="md:col-span-2">
                    <FormInput label="Správa" type="textarea" name="message" required={true} />
                </div>

                <input type="hidden" name="recaptcha" id="recaptcha-token" />

                <div class="md:col-span-2 text-center">
                    <button
                            id="contact-submit"
                            type="submit"
                            class="inline-flex items-center justify-center px-8 py-4 bg-cyan-500 text-white font-semibold rounded-full hover:bg-cyan-600 transition duration-300"
                    >
                        Odoslať správu
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Modal -->
<div id="modal" class="fixed inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 bg-black/25">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full text-center transform scale-95 transition-transform duration-300 shadow-lg">
        <p id="modal-message" class="text-gray-800"></p>
        <button id="modal-close" class="mt-4 px-4 py-2 bg-cyan-500 text-white rounded hover:bg-cyan-600">OK</button>
    </div>
</div>

<script src="https://www.google.com/recaptcha/api.js?render=6LeAlM4rAAAAAGxdb69dWiEQp2TaRv5qLxMMjzow" defer></script>

<script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("contact-form");
        const submitBtn = document.getElementById("contact-submit");
        const modal = document.getElementById("modal");
        const modalMessage = document.getElementById("modal-message");
        const modalClose = document.getElementById("modal-close");

        const showModal = (message) => {
            modalMessage.textContent = message;
            modal.classList.remove("pointer-events-none", "opacity-0");
            modal.classList.add("opacity-100");
            modal.querySelector("div").classList.remove("scale-95");
            modal.querySelector("div").classList.add("scale-100");
        };

        modalClose.addEventListener("click", () => {
            modal.classList.add("opacity-0");
            modal.classList.remove("opacity-100");
            modal.querySelector("div").classList.remove("scale-100");
            modal.querySelector("div").classList.add("scale-95");

            setTimeout(() => modal.classList.add("pointer-events-none"), 300);
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.classList.add("opacity-50", "cursor-not-allowed");

            // wait for grecaptcha
            await new Promise((resolve) => {
                if (typeof grecaptcha !== "undefined") resolve();
                else {
                    const check = setInterval(() => {
                        if (typeof grecaptcha !== "undefined") {
                            clearInterval(check);
                            resolve();
                        }
                    }, 50);
                }
            });

            grecaptcha.ready(async () => {
                const token = await grecaptcha.execute("6LeAlM4rAAAAAGxdb69dWiEQp2TaRv5qLxMMjzow", { action: "submit" });
                document.getElementById("recaptcha-token").value = token;

                try {
                    const res = await fetch("/api/contact", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            name: form.name.value,
                            email: form.email.value,
                            phone: form.phone.value,
                            service: form.service.value,
                            message: form.message.value,
                            recaptcha: token
                        })
                    });

                    const data = await res.json();
                    showModal(data.message);
                    if (res.ok) form.reset();
                } catch (err) {
                    showModal("Chyba pri odosielaní, skúste neskôr.");
                    console.error(err);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
                }
            });
        });
    });
</script>
